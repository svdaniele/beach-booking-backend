-- COMANDO DI AVVIO pg_ctl -D "C:\postgresql-18.1-1-windows-x64-binaries\data" start


-- ============================================
-- BEACH BOOKING - DATABASE INITIALIZATION
-- ============================================

-- Drop existing tables (ATTENZIONE: in production usare migrations)
DROP TABLE IF EXISTS pagamenti CASCADE;
DROP TABLE IF EXISTS prenotazioni CASCADE;
DROP TABLE IF EXISTS ombrelloni CASCADE;
DROP TABLE IF EXISTS users CASCADE;
DROP TABLE IF EXISTS tenants CASCADE;

-- ============================================
-- TABELLA TENANTS (Stabilimenti)
-- ============================================
CREATE TABLE tenants (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    nome_stabilimento VARCHAR(200) NOT NULL,
    slug VARCHAR(100) UNIQUE NOT NULL,
    dominio_custom VARCHAR(255),
    descrizione TEXT,
    indirizzo VARCHAR(255) NOT NULL,
    citta VARCHAR(100) NOT NULL,
    provincia VARCHAR(100) NOT NULL,
    cap VARCHAR(50) NOT NULL,
    telefono VARCHAR(20),
    email VARCHAR(150) NOT NULL,
    piano VARCHAR(50) NOT NULL DEFAULT 'FREE',
    stato VARCHAR(50) NOT NULL DEFAULT 'TRIAL',
    configurazione TEXT,
    logo_url VARCHAR(500),
    iban VARCHAR(34),
    data_creazione TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_scadenza_abbonamento TIMESTAMP,

    CONSTRAINT check_piano CHECK (piano IN ('FREE', 'BASIC', 'PRO', 'ENTERPRISE')),
    CONSTRAINT check_stato CHECK (stato IN ('TRIAL', 'ACTIVE', 'SUSPENDED', 'CANCELLED'))
);

CREATE INDEX idx_tenant_slug ON tenants(slug);
CREATE INDEX idx_tenant_stato ON tenants(stato);

-- ============================================
-- TABELLA USERS (Utenti: admin, staff, clienti)
-- ============================================
CREATE TABLE users (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID REFERENCES tenants(id) ON DELETE CASCADE,
    email VARCHAR(150) NOT NULL,
    password VARCHAR(255) NOT NULL CHECK (password LIKE '{bcrypt}%'),
    nome VARCHAR(100) NOT NULL,
    cognome VARCHAR(100) NOT NULL,
    telefono VARCHAR(20),
    ruolo VARCHAR(50) NOT NULL,
    attivo BOOLEAN NOT NULL DEFAULT TRUE,
    email_verificata BOOLEAN NOT NULL DEFAULT FALSE,
    email_verification_token VARCHAR(255),
    password_reset_token VARCHAR(255),
    password_reset_expiry TIMESTAMP,
    data_registrazione TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    ultimo_accesso TIMESTAMP,

    CONSTRAINT check_ruolo CHECK (ruolo IN ('SUPER_ADMIN', 'TENANT_ADMIN', 'STAFF', 'CUSTOMER')),
    CONSTRAINT uk_email_tenant UNIQUE (email, tenant_id)
);

CREATE INDEX idx_user_email ON users(email);
CREATE INDEX idx_user_tenant ON users(tenant_id);
CREATE INDEX idx_user_ruolo ON users(tenant_id, ruolo);

-- ============================================
-- TABELLA OMBRELLONI
-- ============================================
CREATE TABLE ombrelloni (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    numero INTEGER NOT NULL,
    fila VARCHAR(10) NOT NULL,
    tipo VARCHAR(50) NOT NULL DEFAULT 'STANDARD',
    descrizione TEXT,
    posizione_x INTEGER,
    posizione_y INTEGER,
    attivo BOOLEAN NOT NULL DEFAULT TRUE,
    note TEXT,
    data_creazione TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT check_tipo CHECK (tipo IN ('STANDARD', 'PREMIUM', 'VIP', 'FAMILY')),
    CONSTRAINT uk_tenant_numero UNIQUE (tenant_id, numero)
);

CREATE INDEX idx_ombrellone_tenant ON ombrelloni(tenant_id);
CREATE INDEX idx_ombrellone_attivo ON ombrelloni(tenant_id, attivo);

-- ============================================
-- TABELLA PRENOTAZIONI
-- ============================================
CREATE TABLE prenotazioni (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    tenant_id UUID NOT NULL REFERENCES tenants(id) ON DELETE CASCADE,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    ombrellone_id UUID NOT NULL REFERENCES ombrelloni(id) ON DELETE CASCADE,
    data_inizio DATE NOT NULL,
    data_fine DATE NOT NULL,
    tipo_prenotazione VARCHAR(50) NOT NULL,
    prezzo_totale DECIMAL(10, 2) NOT NULL,
    stato VARCHAR(50) NOT NULL DEFAULT 'PENDING',
    note TEXT,
    codice_prenotazione VARCHAR(50) UNIQUE,
    data_creazione TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT check_tipo_prenotazione CHECK (tipo_prenotazione IN ('GIORNALIERA', 'SETTIMANALE', 'MENSILE', 'ANNUALE')),
    CONSTRAINT check_stato CHECK (stato IN ('PENDING', 'CONFIRMED', 'PAID', 'CANCELLED', 'COMPLETED', 'REFUNDED')),
    CONSTRAINT check_date CHECK (data_fine >= data_inizio)
);

CREATE INDEX idx_prenotazione_tenant ON prenotazioni(tenant_id);
CREATE INDEX idx_prenotazione_user ON prenotazioni(user_id);
CREATE INDEX idx_prenotazione_ombrellone ON prenotazioni(ombrellone_id);
CREATE INDEX idx_prenotazione_date ON prenotazioni(data_inizio, data_fine);
CREATE INDEX idx_prenotazione_stato ON prenotazioni(stato);
CREATE INDEX idx_prenotazione_codice ON prenotazioni(codice_prenotazione);

-- ============================================
-- TABELLA PAGAMENTI
-- ============================================
CREATE TABLE pagamenti (
    id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
    prenotazione_id UUID NOT NULL REFERENCES prenotazioni(id) ON DELETE CASCADE,
    metodo_pagamento VARCHAR(50) NOT NULL,
    importo DECIMAL(10, 2) NOT NULL,
    stato VARCHAR(50) NOT NULL DEFAULT 'PENDING',
    riferimento_esterno VARCHAR(255),
    data_pagamento TIMESTAMP,
    note TEXT,
    data_creazione TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    data_aggiornamento TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,

    CONSTRAINT check_metodo CHECK (metodo_pagamento IN ('PAYPAL', 'BONIFICO', 'CARTA_CREDITO', 'CONTANTI')),
    CONSTRAINT check_stato_pagamento CHECK (stato IN ('PENDING', 'CONFIRMED', 'PAID', 'CANCELLED', 'REFUNDED'))
);

CREATE INDEX idx_pagamento_prenotazione ON pagamenti(prenotazione_id);
CREATE INDEX idx_pagamento_stato ON pagamenti(stato);
CREATE INDEX idx_pagamento_riferimento ON pagamenti(riferimento_esterno);

-- ============================================
-- DATI DI TEST
-- ============================================

-- TENANT 1: Lido Marechiaro (Napoli)
INSERT INTO tenants (id, nome_stabilimento, slug, email, telefono, indirizzo, citta, provincia, cap, piano, stato, data_scadenza_abbonamento)
VALUES (
    '11111111-1111-1111-1111-111111111111',
    'Lido Marechiaro',
    'lido-marechiaro',
    'info@lidomarechiaro.it',
    '081234567',
    'Via Posillipo, 1',
    'Napoli',
    'NA',
    '80123',
    'PRO',
    'ACTIVE',
    CURRENT_TIMESTAMP + INTERVAL '365 days'
);

-- TENANT 2: Bagni Napoli
INSERT INTO tenants (id, nome_stabilimento, slug, email, telefono, indirizzo, citta, provincia, cap, piano, stato, data_scadenza_abbonamento)
VALUES (
    '22222222-2222-2222-2222-222222222222',
    'Bagni Napoli',
    'bagni-napoli',
    'info@bagninapoli.it',
    '081765432',
    'Lungomare Caracciolo, 50',
    'Napoli',
    'NA',
    '80122',
    'BASIC',
    'ACTIVE',
    CURRENT_TIMESTAMP + INTERVAL '30 days'
);

-- USERS per Lido Marechiaro
-- Admin (password: Admin123!)
INSERT INTO users (id, tenant_id, email, password, nome, cognome, telefono, ruolo, attivo, email_verificata)
VALUES (
    '11111111-1111-1111-1111-111111111112',
    '11111111-1111-1111-1111-111111111111',
    'admin@lidomarechiaro.it',
    '$2a$10$N9qo8uLOickgx2ZMRZoMye7tR.qP5VN3.IZn5oIBVlRkjNSO5LgHy', -- Admin123!
    'Mario',
    'Rossi',
    '3331234567',
    'TENANT_ADMIN',
    TRUE,
    TRUE
);

-- Staff
INSERT INTO users (id, tenant_id, email, password, nome, cognome, telefono, ruolo, attivo, email_verificata)
VALUES (
    '11111111-1111-1111-1111-111111111113',
    '11111111-1111-1111-1111-111111111111',
    'staff@lidomarechiaro.it',
    '$2a$10$N9qo8uLOickgx2ZMRZoMye7tR.qP5VN3.IZn5oIBVlRkjNSO5LgHy', -- Admin123!
    'Giuseppe',
    'Verdi',
    '3339876543',
    'STAFF',
    TRUE,
    TRUE
);

-- Cliente
INSERT INTO users (id, tenant_id, email, password, nome, cognome, telefono, ruolo, attivo, email_verificata)
VALUES (
    '11111111-1111-1111-1111-111111111114',
    '11111111-1111-1111-1111-111111111111',
    'cliente@test.it',
    '$2a$10$N9qo8uLOickgx2ZMRZoMye7tR.qP5VN3.IZn5oIBVlRkjNSO5LgHy', -- Admin123!
    'Lucia',
    'Bianchi',
    '3337654321',
    'CUSTOMER',
    TRUE,
    TRUE
);

-- USERS per Bagni Napoli
INSERT INTO users (id, tenant_id, email, password, nome, cognome, telefono, ruolo, attivo, email_verificata)
VALUES (
    '22222222-2222-2222-2222-222222222223',
    '22222222-2222-2222-2222-222222222222',
    'admin@bagninapoli.it',
    '$2a$10$N9qo8uLOickgx2ZMRZoMye7tR.qP5VN3.IZn5oIBVlRkjNSO5LgHy', -- Admin123!
    'Antonio',
    'Esposito',
    '3334567890',
    'TENANT_ADMIN',
    TRUE,
    TRUE
);

-- OMBRELLONI per Lido Marechiaro (50 ombrelloni)
-- Fila A (1-10)
INSERT INTO ombrelloni (tenant_id, numero, fila, tipo, posizione_x, posizione_y, attivo)
SELECT
    '11111111-1111-1111-1111-111111111111',
    generate_series,
    'A',
    CASE
        WHEN generate_series <= 2 THEN 'VIP'
        WHEN generate_series <= 5 THEN 'PREMIUM'
        ELSE 'STANDARD'
    END,
    (generate_series - 1) * 100,
    50,
    TRUE
FROM generate_series(1, 10);

-- Fila B (11-20)
INSERT INTO ombrelloni (tenant_id, numero, fila, tipo, posizione_x, posizione_y, attivo)
SELECT
    '11111111-1111-1111-1111-111111111111',
    generate_series,
    'B',
    'STANDARD',
    (generate_series - 11) * 100,
    150,
    TRUE
FROM generate_series(11, 20);

-- Fila C (21-30)
INSERT INTO ombrelloni (tenant_id, numero, fila, tipo, posizione_x, posizione_y, attivo)
SELECT
    '11111111-1111-1111-1111-111111111111',
    generate_series,
    'C',
    'STANDARD',
    (generate_series - 21) * 100,
    250,
    TRUE
FROM generate_series(21, 30);

-- PRENOTAZIONI di test
INSERT INTO prenotazioni (tenant_id, user_id, ombrellone_id, data_inizio, data_fine, tipo_prenotazione, prezzo_totale, stato, codice_prenotazione)
SELECT
    '11111111-1111-1111-1111-111111111111',
    '11111111-1111-1111-1111-111111111114',
    id,
    CURRENT_DATE + INTERVAL '7 days',
    CURRENT_DATE + INTERVAL '14 days',
    'SETTIMANALE',
    189.00,
    'CONFIRMED',
    'BK' || EXTRACT(EPOCH FROM NOW())::BIGINT || FLOOR(RANDOM() * 1000)::INTEGER
FROM ombrelloni
WHERE tenant_id = '11111111-1111-1111-1111-111111111111'
AND numero IN (1, 5, 10)
LIMIT 3;

-- ============================================
-- VIEWS UTILI
-- ============================================

-- View per statistiche tenant
CREATE OR REPLACE VIEW v_tenant_statistics AS
SELECT
    t.id as tenant_id,
    t.nome_stabilimento,
    t.slug,
    t.piano,
    t.stato,
    COUNT(DISTINCT o.id) as numero_ombrelloni,
    COUNT(DISTINCT u.id) FILTER (WHERE u.ruolo = 'CUSTOMER') as numero_clienti,
    COUNT(DISTINCT p.id) as numero_prenotazioni,
    COUNT(DISTINCT p.id) FILTER (WHERE p.stato = 'PAID') as prenotazioni_pagate,
    COALESCE(SUM(p.prezzo_totale) FILTER (WHERE p.stato IN ('PAID', 'COMPLETED')), 0) as revenue_totale
FROM tenants t
LEFT JOIN ombrelloni o ON t.id = o.tenant_id AND o.attivo = TRUE
LEFT JOIN users u ON t.id = u.tenant_id AND u.attivo = TRUE
LEFT JOIN prenotazioni p ON t.id = p.tenant_id
GROUP BY t.id, t.nome_stabilimento, t.slug, t.piano, t.stato;

-- View per disponibilità ombrelloni
CREATE OR REPLACE VIEW v_disponibilita_ombrelloni AS
SELECT
    o.id as ombrellone_id,
    o.tenant_id,
    o.numero,
    o.fila,
    o.tipo,
    t.nome_stabilimento,
    COUNT(p.id) as numero_prenotazioni,
    MAX(p.data_fine) as ultima_prenotazione_fine
FROM ombrelloni o
JOIN tenants t ON o.tenant_id = t.id
LEFT JOIN prenotazioni p ON o.id = p.ombrellone_id
    AND p.stato NOT IN ('CANCELLED', 'REFUNDED')
WHERE o.attivo = TRUE
GROUP BY o.id, o.tenant_id, o.numero, o.fila, o.tipo, t.nome_stabilimento;

-- ============================================
-- FUNCTIONS UTILI
-- ============================================

-- Funzione per verificare disponibilità ombrellone
CREATE OR REPLACE FUNCTION check_ombrellone_disponibile(
    p_ombrellone_id UUID,
    p_data_inizio DATE,
    p_data_fine DATE
) RETURNS BOOLEAN AS $$
BEGIN
    RETURN NOT EXISTS (
        SELECT 1
        FROM prenotazioni
        WHERE ombrellone_id = p_ombrellone_id
        AND stato NOT IN ('CANCELLED', 'REFUNDED')
        AND (
            (data_inizio <= p_data_inizio AND data_fine >= p_data_inizio)
            OR (data_inizio <= p_data_fine AND data_fine >= p_data_fine)
            OR (data_inizio >= p_data_inizio AND data_fine <= p_data_fine)
        )
    );
END;
$$ LANGUAGE plpgsql;

COMMIT;

-- ============================================
-- QUERY UTILI PER TEST
-- ============================================

-- Verifica setup
SELECT 'Tenants' as tabella, COUNT(*) as records FROM tenants
UNION ALL
SELECT 'Users', COUNT(*) FROM users
UNION ALL
SELECT 'Ombrelloni', COUNT(*) FROM ombrelloni
UNION ALL
SELECT 'Prenotazioni', COUNT(*) FROM prenotazioni;

-- Mostra credenziali di test
SELECT
    'TEST CREDENTIALS' as info,
    '==================' as separator
UNION ALL
SELECT
    'Lido Marechiaro Admin' as info,
    'admin@lidomarechiaro.it / Admin123!' as separator
UNION ALL
SELECT
    'Bagni Napoli Admin' as info,
    'admin@bagninapoli.it / Admin123!' as separator;